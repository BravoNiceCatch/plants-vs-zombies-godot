---
name: 游戏流程完善
status: open
created: 2025-11-23T00:45:07Z
updated: 2025-11-23T00:45:07Z
github: [Will be updated when synced to GitHub]
depends_on: [002, 003, 004, 005, 006]
parallel: false
conflicts_with: []
---

# Task: 游戏流程完善

## Description
实现完整的游戏流程，包括场景切换、游戏状态管理、胜利失败条件判断、暂停功能和游戏循环控制，确保玩家能够体验从头到尾的完整游戏过程。

## Acceptance Criteria
- [ ] 实现主菜单到游戏场景的切换机制
- [ ] 实现完整的游戏循环，包括开始、进行、暂停、结束等状态
- [ ] 实现胜利条件判断 (生存10分钟或击杀20个僵尸)
- [ ] 实现失败条件判断 (僵尸到达左边界或植物全灭)
- [ ] 实现游戏暂停和恢复功能，支持暂停界面交互
- [ ] 实现游戏结束后的重新开始和返回主菜单功能
- [ ] 确保游戏状态正确转换和数据保持

## Technical Details

### 游戏流程管理器 (GameFlowManager)
```csharp
public class GameFlowManager : Node
{
    [Export] public float VictoryTime { get; private set; } = 600f; // 10分钟
    [Export] public int VictoryKills { get; private set; } = 20;

    private GameManager gameManager;
    private float gameTime;
    private bool isGameOver;

    public override void _Ready()
    {
        gameManager = GameManager.Instance;
        gameManager.OnGameStateChanged += OnGameStateChanged;
    }

    public override void _Process(double delta)
    {
        if (gameManager.CurrentState == GameManager.GameState.Playing && !isGameOver)
        {
            UpdateGameTime((float)delta);
            CheckVictoryConditions();
            CheckDefeatConditions();
        }
    }

    public void StartNewGame()
    {
        ResetGameState();
        gameManager.ChangeState(GameManager.GameState.Playing);
        gameTime = 0f;
        isGameOver = false;

        // 初始化游戏系统
        InitializeGameSystems();
    }

    private void ResetGameState()
    {
        gameTime = 0f;
        isGameOver = false;
        gameManager.CurrentSunlight = 50; // 初始阳光
        gameManager.KillCount = 0;

        // 清理现有游戏对象
        ClearExistingGameObjects();

        // 重置各个系统
        ResetGameSystems();
    }

    private void UpdateGameTime(float delta)
    {
        gameTime += delta;
        UpdateGameTimeDisplay();
    }

    private void CheckVictoryConditions()
    {
        bool timeVictory = gameTime >= VictoryTime;
        bool killVictory = gameManager.KillCount >= VictoryKills;

        if (timeVictory || killVictory)
        {
            TriggerVictory(timeVictory);
        }
    }

    private void CheckDefeatConditions()
    {
        bool zombieReachedLeft = CheckZombieReachLeftBoundary();
        bool allPlantsDead = CheckAllPlantsDead();

        if (zombieReachedLeft || allPlantsDead)
        {
            TriggerDefeat();
        }
    }

    private bool CheckZombieReachLeftBoundary()
    {
        var zombies = GetTree().GetNodesInGroup("Zombies");
        foreach (Zombie zombie in zombies)
        {
            if (zombie.Position.X <= 0)
            {
                return true;
            }
        }
        return false;
    }

    private bool CheckAllPlantsDead()
    {
        var plants = GetTree().GetNodesInGroup("Plants");
        return plants.Count == 0;
    }

    private void TriggerVictory(bool timeVictory)
    {
        isGameOver = true;
        gameManager.ChangeState(GameManager.GameState.Victory);

        ShowVictoryScreen(timeVictory);
    }

    private void TriggerDefeat()
    {
        isGameOver = true;
        gameManager.ChangeState(GameManager.GameState.GameOver);

        ShowGameOverScreen();
    }

    private void ShowVictoryScreen(bool timeVictory)
    {
        string victoryMessage = timeVictory ? "生存胜利！" : "击杀胜利！";
        ShowGameEndScreen(victoryMessage, true);
    }

    private void ShowGameOverScreen()
    {
        string defeatMessage = "游戏结束";
        ShowGameEndScreen(defeatMessage, false);
    }

    private void ShowGameEndScreen(string message, bool isVictory)
    {
        var gameEndScreen = ResourceLoader.Load<PackedScene>("res://Scenes/UI/GameEndScreen.tscn").Instantiate();
        gameEndScreen.Call("Setup", message, isVictory, gameTime, gameManager.KillCount);
        GetTree().Root.AddChild(gameEndScreen);
    }

    private void UpdateGameTimeDisplay()
    {
        int minutes = (int)(gameTime / 60f);
        int seconds = (int)(gameTime % 60f);
        string timeText = $"{minutes:00}:{seconds:00}";

        // 更新UI显示
        var gameHUD = GetTree().Root.GetNode("GameScene/UI/GameHUD");
        gameHUD.Call("UpdateGameTime", timeText);
    }

    private void OnGameStateChanged(GameManager.GameState newState)
    {
        switch (newState)
        {
            case GameManager.GameState.Paused:
                ShowPauseScreen();
                break;
            case GameManager.GameState.Playing:
                HidePauseScreen();
                break;
        }
    }

    private void ShowPauseScreen()
    {
        // 暂停所有游戏计时器
        GetTree().Paused = true;

        var pauseScreen = ResourceLoader.Load<PackedScene>("res://Scenes/UI/PauseScreen.tscn").Instantiate();
        GetTree().Root.AddChild(pauseScreen);
    }

    private void HidePauseScreen()
    {
        // 恢复游戏计时器
        GetTree().Paused = false;

        // 移除暂停界面
        var pauseScreen = GetTree().Root.GetNodeOrNull("PauseScreen");
        if (pauseScreen != null)
        {
            pauseScreen.QueueFree();
        }
    }

    public void RestartGame()
    {
        ClearGameEndScreen();
        StartNewGame();
    }

    public void ReturnToMainMenu()
    {
        ClearGameEndScreen();
        gameManager.ChangeState(GameManager.GameState.Menu);

        // 切换回主菜单场景
        GetTree().ChangeSceneToFile("res://Scenes/MainMenu.tscn");
    }

    private void ClearExistingGameObjects()
    {
        // 清理僵尸
        var zombies = GetTree().GetNodesInGroup("Zombies");
        foreach (Node zombie in zombies)
        {
            zombie.QueueFree();
        }

        // 清理植物
        var plants = GetTree().GetNodesInGroup("Plants");
        foreach (Node plant in plants)
        {
            plant.QueueFree();
        }

        // 清理子弹
        var projectiles = GetTree().GetNodesInGroup("Projectiles");
        foreach (Node projectile in projectiles)
        {
            projectile.QueueFree();
        }

        // 清理阳光
        var sunlights = GetTree().GetNodesInGroup("Sunlights");
        foreach (Node sunlight in sunlights)
        {
            sunlight.QueueFree();
        }
    }

    private void InitializeGameSystems()
    {
        // 启动各个游戏系统
        gameManager.SunlightManager.StartGame();
        gameManager.ZombieManager.StartGame();
        gameManager.GridSystem.ClearGrid();
    }

    private void ResetGameSystems()
    {
        // 重置各个系统状态
        gameManager.SunlightManager.Reset();
        gameManager.ZombieManager.Reset();
    }

    private void ClearGameEndScreen()
    {
        var gameEndScreen = GetTree().Root.GetNodeOrNull("GameEndScreen");
        if (gameEndScreen != null)
        {
            gameEndScreen.QueueFree();
        }
    }
}
```

### 场景切换管理器 (SceneManager)
```csharp
public class SceneManager : Node
{
    private GameFlowManager gameFlowManager;

    public override void _Ready()
    {
        gameFlowManager = new GameFlowManager();
        AddChild(gameFlowManager);

        // 设置当前场景的引用
        SetupSceneReferences();
    }

    private void SetupSceneReferences()
    {
        // 根据当前场景设置不同的引用
        var currentScene = GetTree().CurrentScene;

        if (currentScene.Name == "MainMenu")
        {
            SetupMainMenuReferences();
        }
        else if (currentScene.Name == "GameScene")
        {
            SetupGameSceneReferences();
        }
    }

    private void SetupMainMenuReferences()
    {
        var mainMenu = GetTree().CurrentScene.GetNode<MainMenu>("MainMenu");
        mainMenu.OnStartGame += OnStartGameFromMenu;
        mainMenu.OnExitGame += OnExitGameFromMenu;
    }

    private void SetupGameSceneReferences()
    {
        // 游戏场景已经在游戏管理器中初始化
        gameFlowManager.StartNewGame();
    }

    private void OnStartGameFromMenu()
    {
        // 切换到游戏场景
        GetTree().CallDeferred(nameof(SceneTree.ChangeSceneToFile), "res://Scenes/GameScene.tscn");
    }

    private void OnExitGameFromMenu()
    {
        GetTree().Quit();
    }
}
```

### 游戏结束界面脚本 (GameEndScreen)
```csharp
public partial class GameEndScreen : Control
{
    private Label titleLabel;
    private Label statsLabel;
    private Button restartButton;
    private Button menuButton;

    public override void _Ready()
    {
        SetupUI();
    }

    public void Setup(string message, bool isVictory, float gameTime, int killCount)
    {
        titleLabel.Text = message;
        titleLabel.Modulate = isVictory ? Colors.Green : Colors.Red;

        string statsText = $"游戏时间: {FormatTime(gameTime)}\n击杀僵尸: {killCount}";
        statsLabel.Text = statsText;

        SetupButtons();
    }

    private void SetupUI()
    {
        // 创建UI元素
        titleLabel = new Label();
        titleLabel.Position = new Vector2(960, 400);
        titleLabel.HorizontalAlignment = HorizontalAlignment.Center;
        titleLabel.Size = new Vector2(300, 50);
        AddChild(titleLabel);

        statsLabel = new Label();
        statsLabel.Position = new Vector2(960, 500);
        statsLabel.HorizontalAlignment = HorizontalAlignment.Center;
        statsLabel.Size = new Vector2(300, 100);
        AddChild(statsLabel);

        restartButton = new Button();
        restartButton.Text = "重新开始";
        restartButton.Position = new Vector2(860, 600);
        restartButton.Size = new Vector2(200, 50);
        restartButton.Pressed += OnRestartPressed;
        AddChild(restartButton);

        menuButton = new Button();
        menuButton.Text = "返回主菜单";
        menuButton.Position = new Vector2(860, 670);
        menuButton.Size = new Vector2(200, 50);
        menuButton.Pressed += OnMenuPressed;
        AddChild(menuButton);
    }

    private void SetupButtons()
    {
        // 按钮已在SetupUI中配置
    }

    private void OnRestartPressed()
    {
        var gameFlowManager = GetTree().Root.GetNode("SceneManager/GameFlowManager");
        gameFlowManager.Call("RestartGame");
        QueueFree();
    }

    private void OnMenuPressed()
    {
        var gameFlowManager = GetTree().Root.GetNode("SceneManager/GameFlowManager");
        gameFlowManager.Call("ReturnToMainMenu");
    }

    private string FormatTime(float time)
    {
        int minutes = (int)(time / 60f);
        int seconds = (int)(time % 60f);
        return $"{minutes:00}:{seconds:00}";
    }
}
```

### 暂停界面脚本 (PauseScreen)
```csharp
public partial class PauseScreen : Control
{
    private Button continueButton;
    private Button menuButton;

    public override void _Ready()
    {
        SetupUI();
    }

    private void SetupUI()
    {
        // 半透明背景
        ColorRect background = new ColorRect();
        background.Color = new Color(0, 0, 0, 0.7f);
        background.Size = new Vector2(1920, 1080);
        AddChild(background);

        // 暂停标题
        Label titleLabel = new Label();
        titleLabel.Text = "游戏暂停";
        titleLabel.Position = new Vector2(960, 400);
        titleLabel.HorizontalAlignment = HorizontalAlignment.Center;
        titleLabel.Size = new Vector2(300, 50);
        AddChild(titleLabel);

        // 继续游戏按钮
        continueButton = new Button();
        continueButton.Text = "继续游戏";
        continueButton.Position = new Vector2(860, 500);
        continueButton.Size = new Vector2(200, 50);
        continueButton.Pressed += OnContinuePressed;
        AddChild(continueButton);

        // 返回主菜单按钮
        menuButton = new Button();
        menuButton.Text = "返回主菜单";
        menuButton.Position = new Vector2(860, 570);
        menuButton.Size = new Vector2(200, 50);
        menuButton.Pressed += OnMenuPressed;
        AddChild(menuButton);
    }

    private void OnContinuePressed()
    {
        GameManager.Instance.ResumeGame();
        QueueFree();
    }

    private void OnMenuPressed()
    {
        GameManager.Instance.ChangeState(GameManager.GameState.Menu);
        GetTree().ChangeSceneToFile("res://Scenes/MainMenu.tscn");
        QueueFree();
    }
}
```

## Dependencies
- [ ] Task 002: 核心系统开发完成
- [ ] Task 003: UI界面开发完成
- [ ] Task 004: 植物系统实现完成
- [ ] Task 005: 僵尸和战斗系统实现完成
- [ ] Task 006: 阳光经济系统实现完成

## Effort Estimate
- Size: L
- Hours: 24
- Parallel: false (需要依赖所有其他任务)

## Definition of Done
- [ ] 玩家能够从主菜单开始游戏
- [ ] 游戏能够正确暂停和恢复
- [ ] 胜利条件 (时间/击杀) 正确触发
- [ ] 失败条件 (僵尸突破/植物全灭) 正确触发
- [ ] 游戏结束后能够重新开始或返回菜单
- [ ] 所有游戏状态转换正常工作
- [ ] 游戏流程通过完整用户体验测试
- [ ] 代码完成并通过集成测试
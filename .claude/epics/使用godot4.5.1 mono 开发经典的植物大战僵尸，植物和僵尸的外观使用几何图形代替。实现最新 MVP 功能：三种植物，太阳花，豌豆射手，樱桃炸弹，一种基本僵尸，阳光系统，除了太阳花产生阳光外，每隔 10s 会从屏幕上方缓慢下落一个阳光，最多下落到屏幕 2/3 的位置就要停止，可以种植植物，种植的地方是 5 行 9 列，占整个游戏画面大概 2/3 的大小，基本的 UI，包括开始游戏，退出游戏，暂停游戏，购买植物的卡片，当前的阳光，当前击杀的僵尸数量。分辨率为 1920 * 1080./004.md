---
name: 植物系统实现
status: open
created: 2025-11-23T00:45:07Z
updated: 2025-11-23T00:45:07Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002]
parallel: true
conflicts_with: [005]
---

# Task: 植物系统实现

## Description
实现三种核心植物的完整功能系统，包括植物基类、具体植物实现、种植机制和植物行为逻辑，为游戏提供防御单位的完整功能。

## Acceptance Criteria
- [ ] 实现植物基类 Plant，包含基础属性和抽象方法
- [ ] 实现太阳花，每5秒产生25单位阳光
- [ ] 实现豌豆射手，每秒发射一个豌豆子弹
- [ ] 实现樱桃炸弹，准备2秒后产生范围爆炸伤害
- [ ] 创建植物工厂类，支持植物的创建和管理
- [ ] 实现植物的种植、移除和状态管理机制
- [ ] 使用几何图形表示不同植物的外观

## Technical Details

### 植物基类 (Plant)
```csharp
public abstract class Plant : Node2D
{
    [Export] public int Cost { get; protected set; }
    [Export] public int MaxHealth { get; protected set; }
    public int CurrentHealth { get; protected set; }
    public Vector2Int GridPosition { get; set; }

    protected Timer behaviorTimer;

    public abstract void OnPlanted();
    public abstract void UpdateBehavior();
    public virtual void TakeDamage(int damage);
    protected virtual void Die();

    protected virtual void DrawPlantShape(); // 几何图形绘制
}
```

### 太阳花 (Sunflower)
```csharp
public class Sunflower : Plant
{
    private const int SUNLIGHT_PRODUCTION = 25;
    private const float PRODUCTION_INTERVAL = 5f;

    public override void _Ready()
    {
        Cost = 50;
        MaxHealth = 50;
        CurrentHealth = MaxHealth;

        SetupProductionTimer();
        DrawSunflowerShape();
    }

    private void SetupProductionTimer()
    {
        behaviorTimer = new Timer();
        behaviorTimer.WaitTime = PRODUCTION_INTERVAL;
        behaviorTimer.Timeout += OnProduceSunlight;
        behaviorTimer.Autostart = true;
        AddChild(behaviorTimer);
    }

    private void OnProduceSunlight()
    {
        // 通知阳光管理器产生阳光
        GameManager.Instance.SunlightManager.ProduceFromSunflower(this);
    }

    private void DrawSunflowerShape()
    {
        // 绘制黄色圆形代表太阳花
    }
}
```

### 豌豆射手 (Peashooter)
```csharp
public class Peashooter : Plant
{
    private const float SHOOT_INTERVAL = 1f;
    private PackedScene peaScene;

    public override void _Ready()
    {
        Cost = 100;
        MaxHealth = 50;
        CurrentHealth = MaxHealth;

        peaScene = GD.Load<PackedScene>("res://Scenes/Projectiles/Pea.tscn");
        SetupShootingTimer();
        DrawPeashooterShape();
    }

    private void SetupShootingTimer()
    {
        behaviorTimer = new Timer();
        behaviorTimer.WaitTime = SHOOT_INTERVAL;
        behaviorTimer.Timeout += OnShoot;
        AddChild(behaviorTimer);
        behaviorTimer.Start();
    }

    private void OnShoot()
    {
        if (HasZombieInLane())
        {
            ShootPea();
        }
    }

    private bool HasZombieInLane()
    {
        // 检查同行是否有僵尸
        return GameManager.Instance.ZombieManager.HasZombieInRow(GridPosition.Y);
    }

    private void ShootPea()
    {
        var pea = peaScene.Instantiate<Pea>();
        pea.GlobalPosition = GetShootPosition();
        GetParent().AddChild(pea);
    }
}
```

### 樱桃炸弹 (CherryBomb)
```csharp
public class CherryBomb : Plant
{
    private const float EXPLOSION_DELAY = 2f;
    private const int EXPLOSION_DAMAGE = 1800; // 足够一击秒杀所有僵尸
    private const float EXPLOSION_RADIUS = 150f;

    public override void _Ready()
    {
        Cost = 150;
        MaxHealth = 50;
        CurrentHealth = MaxHealth;

        SetupExplosionTimer();
        DrawCherryBombShape();
    }

    private void SetupExplosionTimer()
    {
        behaviorTimer = new Timer();
        behaviorTimer.WaitTime = EXPLOSION_DELAY;
        behaviorTimer.Timeout += OnExplode;
        behaviorTimer.OneShot = true;
        AddChild(behaviorTimer);
        behaviorTimer.Start();

        // 开始闪烁警告效果
        StartWarningAnimation();
    }

    private void OnExplode()
    {
        // 触发爆炸效果
        GameManager.Instance.CombatManager.TriggerExplosion(
            GlobalPosition, EXPLOSION_RADIUS, EXPLOSION_DAMAGE
        );

        Die();
    }
}
```

### 植物工厂 (PlantFactory)
```csharp
public class PlantFactory
{
    private Dictionary<PlantType, PackedScene> plantScenes;

    public PlantFactory()
    {
        LoadPlantScenes();
    }

    public Plant CreatePlant(PlantType type, Vector2Int gridPosition)
    {
        if (!plantScenes.ContainsKey(type))
            return null;

        var plant = plantScenes[type].Instantiate<Plant>();
        plant.GridPosition = gridPosition;
        return plant;
    }

    private void LoadPlantScenes()
    {
        plantScenes = new Dictionary<PlantType, PackedScene>
        {
            [PlantType.Sunflower] = GD.Load<PackedScene>("res://Scenes/Plants/Sunflower.tscn"),
            [PlantType.Peashooter] = GD.Load<PackedScene>("res://Scenes/Plants/Peashooter.tscn"),
            [PlantType.CherryBomb] = GD.Load<PackedScene>("res://Scenes/Plants/CherryBomb.tscn")
        };
    }
}
```

### 几何图形设计
- **太阳花**: 黄色圆形 + 小圆形花瓣
- **豌豆射手**: 绿色矩形 + 小圆形头部
- **樱桃炸弹**: 红色双圆形组合

## Dependencies
- [ ] Task 001: 项目基础搭建完成
- [ ] Task 002: 核心系统开发完成 (GameManager, GridSystem)

## Effort Estimate
- Size: L
- Hours: 32
- Parallel: true (可与僵尸和战斗系统并行)

## Definition of Done
- [ ] 三种植物的所有行为正确实现
- [ ] 植物能够正确种植到网格中
- [ ] 植物的视觉效果使用几何图形实现
- [ ] 植物工厂能够正确创建和管理植物
- [ ] 植物系统与网格系统正确集成
- [ ] 所有植物通过单元测试和集成测试
- [ ] 代码符合性能要求 (50+植物同时运行)